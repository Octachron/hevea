#! /bin/sh
LATEX=latex
DVIPS=dvips
GS=gs
PNMCROP=pnmcrop
PPMTOGIF=ppmtogif
PNMMARGIN=pnmmargin
RM="/bin/rm -f"
case $1 in
  '')
   BASE=image
   ;;
  *)
   BASE=$1
  ;;
esac

NAME=${BASE}.image
DVIPSOPTS="-t a3 -x1414"
GSOPTS="-q -sPAPERSIZE=a3 -dNOPAUSE -dNO_PAUSE -sDEVICE=ppmraw -dTextAlphaBits=2"
PPMTOGIFOPTS="-transparent  #ffffff"
PNMMARGINOPTS="-white 1"

NEWDVIPS=true
if ${DVIPS} -i 2>&1 | grep -i 'bad option' 2> /dev/null 1> /dev/null
then
  NEWDVIPS=false
fi

test -f  ${NAME}.tex ||\
{ echo "Failure: no ${NAME}.tex file!" 2>&1 ; exit 2 ; }
${LATEX} ${BASE}.image.tex

if ${NEWDVIPS}
then
  DVIPSOPTS="${DVIPSOPTS} -S 1 -i"
  ${DVIPS} ${DVIPSOPTS} -o${BASE} ${NAME}.dvi
  ${RM} ${NAME}.log ${NAME}.aux ${NAME}.dvi

  test -f ${BASE}001 || {  echo "Failure: no ps files!" 2>&1 ; exit 2 ; }
  for i in ${BASE}[0-9][0-9][0-9]
  do
    mv $i $i.ps
    (echo "($i.ps) run" ; echo "quit") |\
    ${GS} ${GSOPTS} -sOutputFile=$i.ppm
    ${PNMCROP} < $i.ppm  |\
    ${PNMMARGIN} ${PNMMARGINOPTS} |\
    ${PPMTOGIF} ${PPMTOGIFOPTS} > $i.gif
    ${RM} $i.ps $i.ppm
  done
else
  ${DVIPS} ${DVIPSOPTS} -o${BASE}.ps ${NAME}.dvi
  ${RM} ${NAME}.log ${NAME}.aux ${NAME}.dvi

  test -f ${BASE}.ps || { echo "No ps file!" 2>&1 ; exit 2 ; }

  (echo "(${BASE}.ps) run" ; echo "quit") |\
  ${GS} ${GSOPTS} -sOutputFile=${BASE}%03d
  ${RM} ${BASE}.ps

  test -f ${BASE}001 || { echo "No ppm files!"  2>&1 ; exit 2 ; }
  for i in ${BASE}[0-9][0-9][0-9]
  do
    ${PNMCROP}  < $i |\
    ${PNMMARGIN} ${PNMMARGINOPTS} |\
    ${PPMTOGIF} ${PPMTOGIFOPTS}  > $i.gif
    ${RM} $i
  done
fi